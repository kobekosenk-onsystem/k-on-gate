<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>K-on! Gateway</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body style="text-align:center; padding-top:100px; font-family:sans-serif; background-color:#f4f4f4; color:#333;">
  <div id="status">
    <p>部室予約システムを起動中...</p>
    <div style="margin: 20px auto; width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
  </div>
  <div id="retry" style="display:none;">
    <p>起動に時間がかかっています</p>
    <button onclick="location.reload()" style="padding:10px 20px;">再読み込み</button>
  </div>

  <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

  <script>
    const LIFF_ID = "2008880240-ln3wSnTk"; 
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx0gQXbe86ygAkaqhpHzlDe6DTM7lOi-GTK-MAXEQjXD6F0ox_PdJ29SfQingCOPl70Qw/exec";

    // 5秒経っても動かない場合にボタンを出す
    setTimeout(() => { document.getElementById('retry').style.display = 'block'; }, 5000);

    window.onload = function() {
      liff.init({ liffId: LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          liff.getProfile().then(p => {
            // 履歴を上書きしてGASへ移動
            window.location.replace(GAS_URL + "?uid=" + p.userId);
          }).catch(e => {
            document.getElementById('status').innerHTML = "プロフィール取得失敗: " + e;
          });
        }
      }).catch(err => {
        document.getElementById('status').innerHTML = "LIFF初期化失敗: " + err + "<br>LINE DevelopersでこのGitHubのURLが『Endpoint URL』に登録されているか確認してください。";
      });
    };
  </script>
</body>
</html>
